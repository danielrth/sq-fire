<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
		<script src="https://www.gstatic.com/firebasejs/3.6.4/firebase.js"></script>
		<script src="//code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.js"></script>
		<script>
		  // Initialize Firebase
		  var config = {
		    apiKey: "AIzaSyAww79znw0R6SMDvTrgca2Jqgt3EZK7bIQ",
		    authDomain: "suresite-dfb2d.firebaseapp.com",
		    databaseURL: "https://suresite-dfb2d.firebaseio.com",
		    storageBucket: "suresite-dfb2d.appspot.com",
		    messagingSenderId: "634728179109"
		  };
		  firebase.initializeApp(config);
		</script>
		
		<link rel="stylesheet" type="text/css" href="//code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css">
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.min.css">
		<style>
		#insite {
			width: 900px;
			border: 1px solid #555;
			padding: 15px;
			margin: auto;
		}
		#insite > div {
			margin-bottom: 40px;	
		}
		button {
			border: 2px solid #6081AF;
			border-radius: 5px;
			background-color: #AAA;
			font-size: 18px;
		    color: white;
		}
		button.active {
			background-color: #777;
		}
		#mnu-login button {
		    width: 200px;
		    height: 40px;
		    margin-left: 75px;
		}
		#img-body {
			background-image: url("https://static1.squarespace.com/static/53716c1de4b07f5891299dc4/t/586e8b8a29687f370f77d456/1483639705058/?format=1000w");
			background-color: #D8E6FC;
			background-size: cover;
			background-position: center;
			width: 800px;
			height: 500px;
			margin: 25px auto;
		}
		#container-img {
			width: 850px;
			height: 550px;
			border: 1px solid #BBB;
			margin-left: auto;
			margin-right: auto;
			position: relative;
			box-shadow: 1px 1px 5px #888888;
		}
		.ins_popup {
			border: 1px solid #6081AF;
		    width: 250px;
		    background-color: #CCC;
		    border-radius: 5px;
		    position: absolute;
		    margin: auto;
		    left: 350px;
		    top: 250px;
		}
		.ins_popup input:not([type='checkbox']) {
			text-align: center;
			width: 160px;
			height: 26px;
			border: 1px solid #000;
			background-color: white;
			border-radius: 3px;
			font-size: 16px;
		}
		.ins_popup input[type='checkbox'] {
			float: right;
			font-size: 200%;
		}
		.ins_popup p {
			margin: 10px auto 0 auto;
			text-align: center;
		}
		.ins_popup button {
			height: 28px;
		}
		.ins_popup select {
			width: 100px;
		    height: 26px;
		    font-size: 16px;
		}
		.ins_popup div {
			border: 1px solid #000;
			border-radius: 4px;
			height: 26px;
			background-color: white;
		}
		.ins_popup td {
			height: 35px;
			text-align: center;
		}
		.ins_popup td button {
			width: 100px;
		}
		#btn-login-ggl,#btn-login-fb {
			width: 200px;
			font-size: 14px;
		}
		#btn-close-dlg {
			background-image: url("https://static1.squarespace.com/static/53716c1de4b07f5891299dc4/t/586f144ebf629abf691ffe70/1483674708451/?format=300w");
			background-size: cover;
			background-position: center;
			width: 30px;
			height: 30px;
			cursor: pointer;
			position: absolute;
			top: 0;
			right: 0;
		}
		#site-pin {
			background-image: url("https://static1.squarespace.com/static/53716c1de4b07f5891299dc4/t/58721096db29d687bc48e5cf/1483870363388/?format=100w");
			background-size: cover;
			background-position: center;
			width: 25px;
			height: 25px;
			position: absolute;
		}
		</style>
	</head>
	<body>
		<div id="insite">
			<div id='mnu-login'>
				<button id="btn-dlg-login" onClick="switchPopupView(0)">LOG IN</button>
				<button id="btn-dlg-reg" onClick="switchPopupView(1)">REGISTER</button>
				<button id="btn-dlg-reset-pwd" onClick="switchPopupView(2)">RESET PASSWORD</button>
				<p id="alt-verify" style="text-align:center;"></p>
			</div>
			<div id="mnu-logged">
				<!-- <p>Welcome: <span id="p-logged-username"></span></p>
				<p id="p-logged-email"></p> -->
				<button id="welc" style="display:inline-block;">Welcome: <span id="p-logged-username"></span></button>
				<button id="btn-stat-addsite" onClick="switchFlowStatus(1)">ADD SITE</button>
				<button id="btn-stat-review" onClick="switchFlowStatus(2)">REVIEW</button>
				<button id="btn-signout" onClick="handleSignout()">SIGN OUT</button>
			</div>
			<div id="container-img">
				<div id="img-body"></div>
				<div id="site-pin" style="display:none;"></div>
			</div>
			<div id="dlg-login" class="ins_popup" style="height:240px;">
				<p><input type="text" placeholder="Email" id="txt-email"/></p>
				<p><input type="Password" placeholder="Password" id="txt-pwd"/></p>
				<p><button id="btn-smb-login" onClick="handleSignin()">Login</button></p>
				<p><button id="btn-login-ggl" onClick="handleGoogleSignin()">Sign in with Google</button></p>
				<p><button id="btn-login-fb" onClick="handleFBSignin()">Sign in with Facebook</button></p>
				<div id="btn-close-dlg" onClick="switchPopupView(-1)"></div>
			</div>
			<div id="dlg-reg-user" class="ins_popup" style="height:320px;">
				<p><input type="text" placeholder="User name" id="txt-reg-name"/></p>
				<p><input type="text" placeholder="Email" id="txt-reg-email"/></p>
				<p><input type="Password" placeholder="Password" id="txt-reg-pwd"/></p>
				<p><input type="Password" placeholder="Reenter password" id="txt-reg-conf"/></p>
				<p><button id="btn-smb-reg-user" onClick="handleSignup()">Submit</button></p>
				<div id="btn-close-dlg" onClick="switchPopupView(-1)"></div>
				<p><button id="btn-login-ggl" onClick="handleGoogleSignin()">Sign up with Google</button></p>
				<p><button id="btn-login-fb" onClick="handleFBSignin()">Sign up with Facebook</button></p>
			</div>
			<div id="dlg-reset-pwd" class="ins_popup" style="height:150px;">
				<p><input type="email" placeholder="Email" id="txt-re-email"/></p>
				<p><button id="btn-smb-reg-user" onClick="sendPasswordReset()">Send</button></p>
				<div id="btn-close-dlg" onClick="switchPopupView(-1)"></div>
			</div>
			<div id="dlg-add-site" class="ins_popup" style="height:200px;padding:10px;">
				<table>
					<tr>
						<td><input text="text" id="txt-in-asbg" style="width:120px;" maxlength=3 placeholder="ASBG value" /></td>
						<td><select id="sel-in-unit"></select></td>
					</tr>
					<tr>
						<td colspan=2><input id="txt-in-time" style="width:240px;margin:auto;"/></td>
					</tr>
					<tr>
						<td><div><span>Painful</span><input type="checkbox" id="chk-in-painful"></div></td>
						<td><div><span>Bleeding</span><input type="checkbox" id="chk-in-bleeding"></div></td>
					</tr>
					<tr>
						<td><div><span>Rash</span><input type="checkbox" id="chk-in-rash"></div></td>
						<td><div><span>Erratic BG</span><input type="checkbox" id="chk-in-erratic"></div></td>
					</tr>
					<tr>
						<td><button id="btn-in-save" onClick="saveNewSite()">SAVE</button></td>
						<td><button id="btn-in-cancel" onClick="cancelNewSite()">CANCEL</button></td>
					</tr>
				</table>
			</div>
			<div>
				<table border=1 id="tbl-user-sites">
					<thead>
						<tr>
							<th>Date</th><th>ASBG</th><th>mg/dl</th><th>Pain</th><th>Bleeding</th><th>Rash</th><th>Erratic BG</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
	</body>
</html>

<script>
	var viewIDs = ['#dlg-login', '#dlg-reg-user', '#dlg-reset-pwd', '#dlg-add-site']; //layout IDs for dialogs
	var asbgUnits = ['mg/dl', 'mmol/L'];
	var flowStatusNames = ["loggedin", "addsite", "review"];	//flow status names
	var flowStatus = 0;
	var imageMargin = 25;
	var newSiteOffsetX = -50;
	var newSiteOffsetY = -50;
	var editingPin = null;
	var userSitesData = [];

	$(document).ready(function() {

		initUserAuth()
		switchPopupView(-1);

		$.each(asbgUnits, function(key, value) {   
		     $('#sel-in-unit')
		         .append($("<option></option>")
		                    .attr("value",key)
		                    .text(value)); 
		});

		$('#txt-in-asbg').keyup(function () { 
		    this.value = this.value.replace(/[^0-9\.]/g,'');
		});

		$('#txt-in-time').datetimepicker({
			controlType: 'select',
			oneLine: true,
			dateFormat: 'M.d yy,', 
			timeFormat: 'h:mm tt'
		});

		$('#img-body').click(function (e) {
			if ($('#dlg-add-site').is(":visible")) {
				return;
			}
			if (flowStatus == 1) //flow status for adding site
			{
				//real data to store is offsetX, offsetY
				newSiteOffsetX = e.offsetX;
				newSiteOffsetY = e.offsetY;

            	addPinOnImage(newSiteOffsetX, newSiteOffsetY);
            	
            	$('#dlg-add-site').show();
            	$('#dlg-add-site').css('top', newSiteOffsetY + 200);
            	// $('#dlg-add-site').css('left', newSiteOffsetX);
            	$('#txt-in-time').datetimepicker('setDate', (new Date()) );
			}
		});

	});

	function switchFlowStatus (stat) {
		flowStatus = stat;
		if (stat == 1) {
			$('#btn-stat-addsite').addClass('active');
		}
		else {
			$('#btn-stat-addsite').removeClass('active');	
		}
	} 

	function switchPopupView(viewNum) {
		//hide/show popup dialogs
		for (var i = 0; i < viewIDs.length; i++) {
			if (i == viewNum)
				$(viewIDs[viewNum]).show();
			else
				$(viewIDs[i]).hide();
		}
	}

    function initUserAuth() {
    	//when user auth status changed
    	firebase.auth().onAuthStateChanged(function(user) {
    		if (user) {
    			if (user.emailVerified) {
    				// console.log(user);
    				$('#p-logged-email').html(user.email);
	    			if (user.displayName) 
	    				$('#p-logged-username').html(user.displayName);
	    			else if (user.providerData[0]['displayName']) {
	    				$('#p-logged-username').html(user.providerData[0]['displayName']);
	    			}

	    			switchPopupView(-1);
	    			$('#mnu-login').hide();
	    			$('#mnu-logged').show();
	    			$('#alt-verify').html("");

	    			loadUserSites();
    			}
    			else {
    				$('#mnu-login').show();
    				$('#mnu-logged').hide();
    				$('#alt-verify').html("Your account was not verified by email.\n Please check the verification email in your mainbox.");
    			}
    		}
    		else {
    			$('#mnu-login').show();
    			$('#mnu-logged').hide();
    		}
    	});
    }

    function handleSignin() {
    	var email = $('#txt-email').val();
        var password = $('#txt-pwd').val();
        if (email.length < 4) {
        	alert('Please enter an email address.');
        	return;
        }
        if (password.length < 4) {
        	alert('Please enter a password.');
        	return;
        }
        firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error){
        	var errorCode = error.code;
	        var errorMessage = error.message;
	        
	        if (errorCode === 'auth/wrong-password') {
	          alert('Wrong password.');
	        } else {
	          alert(errorMessage);
	        }
	        console.log(error);
        });
    }

    function handleSignup() {
    	var email = $('#txt-reg-email').val();
        var password = $('#txt-reg-pwd').val();
        var confPassword = $('#txt-reg-conf').val();
        var	username = $('#txt-reg-name').val();

	    if (username.length < 4) {
	        alert('Please enter a password.');
	        return;
	    }
        if (email.length < 4) {
	        alert('Please enter an email address.');
	        return;
	    }
	    if (password.length < 4) {
	        alert('Please enter a password.');
	        return;
	    }
	    if (password != confPassword) {
	        alert('Please confirm the entered password.');
	        return;
	    }

	    firebase.auth().createUserWithEmailAndPassword(email, password).then(function(user) {

		    user.updateProfile({
		        displayName: username
		    }).then(function() {
		        $('#p-logged-username').html(username);
		        firebase.auth().currentUser.sendEmailVerification().then(function() {
			        alert('Email Verification Sent!');
			        switchPopupView(-1);
			    });
		    }, function(error) {
		        console.error(error);
		    });        
		}, function(error) {
		    var errorCode = error.code;
		    var errorMessage = error.message;
		    alert(error.message);
		});
    }

    function handleGoogleSignin () {
    	var provider = new firebase.auth.GoogleAuthProvider();
    	provider.addScope('https://www.googleapis.com/auth/plus.login');
    	firebase.auth().signInWithPopup(provider).then(function(result) {
    		var token = result.credential.accessToken;
      		var user = result.user;
      		if (!user.emailVerified) {
      			firebase.auth().currentUser.sendEmailVerification().then(function() {
			        alert('Email Verification Sent!');
			        switchPopupView(-1);
			    });
      		}
    	}).catch(function(error) {
    		var errorCode = error.code;
    		if (errorCode === 'auth/account-exists-with-different-credential') {
	            alert('You have already signed up with a different auth provider for that email.');
	        } else {
	            console.error(error);
	        }
    	})
    }

    function handleFBSignin() {
    	var provider = new firebase.auth.FacebookAuthProvider();
    	provider.addScope('user_birthday');
    	firebase.auth().signInWithPopup(provider).then(function(result) {
        	var token = result.credential.accessToken;
          	var user = result.user;
          	if (!user.emailVerified) {
      			firebase.auth().currentUser.sendEmailVerification().then(function() {
			        alert('Email Verification Sent!');
			    });
      		}
        }).catch(function(error) {
            var errorCode = error.code;
    		if (errorCode === 'auth/account-exists-with-different-credential') {
	            alert('You have already signed up with a different auth provider for that email.');
	        } else {
	            console.error(error);
	        }
        });
    }

    function sendPasswordReset() {
      	var email =  $('#txt-re-email').val();
      	firebase.auth().sendPasswordResetEmail(email).then(function() {
        	alert('Password Reset Email Sent!');
        }).catch(function(error) {
        	var errorCode = error.code;
        	var errorMessage = error.message;
        	if (errorCode == 'auth/invalid-email') {
	        	alert(errorMessage);
	        } else if (errorCode == 'auth/user-not-found') {
	        	alert(errorMessage);
	        }
	        console.log(error);
      });
    }

    function handleSignout() {
    	switchFlowStatus(0);
    	$('#tbl-user-sites tbody').html('');
    	userSitesData = [];

    	if (firebase.auth().currentUser) {
	        // [START signout]
	        firebase.auth().signOut();
	        // [END signout]
	     }
    }

    function saveNewSite() {
    	if (!$('#txt-in-asbg').val()) {
    		alert ("Please input valid ASBG value.");
    		return;
    	}

    	if (!$('#txt-in-time').val()) {
    		alert ("Please input valid date and time value.");
    		return;
    	}

    	var asbgVal = $('#sel-in-unit').val() == 0 ? $('#txt-in-asbg').val() : $('#txt-in-asbg').val() * 18;
    	var newSiteData = {
    		'userid': firebase.auth().currentUser.uid,
    		'locX': newSiteOffsetX,
    		'locY': newSiteOffsetY,
    		'asbg': asbgVal,
    		'injtime': $('#txt-in-time').datetimepicker('getDate').getTime(),
    		'isPainful': $('#chk-in-painful').is(':checked') ? 'yes' : 'no',
    		'isBleeding': $('#chk-in-bleeding').is(':checked') ? 'yes' : 'no',
    		'isRash': $('#chk-in-rash').is(':checked') ? 'yes' : 'no',
    		'isErratic': $('#chk-in-erratic').is(':checked') ? 'yes' : 'no'
    	};

    	var newPostKey = firebase.database().ref().child('sites').push().key;
		var updates = {};
		updates['/sites/' + newPostKey] = newSiteData;

		console.log(firebase.database().ref().update(updates));
		switchPopupView(-1);
    }

    function cancelNewSite() {
    	editingPin.remove();
    	switchPopupView(-1);
    }

    function loadUserSites () {
    	firebase.database().ref().child('sites').orderByChild("userid").equalTo(firebase.auth().currentUser.uid).on("child_added", function(snapshot) {
		  		
		  		userSitesData.push(snapshot.val());

		  		var injtime = formatDate (new Date(snapshot.val().injtime));
		  		var trHtml = 
		  			"<tr id=trsite_" + snapshot.key + "><td>" + injtime  + "</td><td>" 
		  			+ snapshot.val().asbg + "</td><td>" 
		  			+ "mg/dl" + "</td><td>" 
		  			+ getCheckboxHTML(snapshot.val().isPainful) + "</td><td>" 
		  			+ getCheckboxHTML(snapshot.val().isBleeding) + "</td><td>" 
		  			+ getCheckboxHTML(snapshot.val().isRash) + "</td><td>" 
		  			+ getCheckboxHTML(snapshot.val().isErratic) + "</td>" 
		  			+ "<td><a href='#' onClick=removeSite('"+ snapshot.key +"') >DELETE</a></td></tr>";
		  		$('#tbl-user-sites tbody').html($('#tbl-user-sites tbody').html() + trHtml);

		  		addPinOnImage(snapshot.val().locX, snapshot.val().locY);
		});

		firebase.database().ref().child('sites').orderByChild("userid").equalTo(firebase.auth().currentUser.uid).on("child_removed", function(snapshot) {
			var trSite = $('#trsite_' + snapshot.key);
			trSite.remove();
		});
    }

    function formatDate (dateVar) {
    	var monthNames = [
		  "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
		];

		var day = dateVar.getDate();
		var monthIndex = dateVar.getMonth();
		var year = dateVar.getFullYear();

		return monthNames[monthIndex] + '. ' + day + ', ' + year;
    }

    function getCheckboxHTML(varBool) {
    	return "<input type='checkbox' onclick='return false;' " + (varBool=='yes'?'checked':'') + " />";
    }

    function addPinOnImage(offsetX, offsetY) {
    	var posX = offsetX + imageMargin - $('#site-pin').width()/2,
            posY = offsetY + imageMargin - $('#site-pin').height()/2;

    	editingPin = $('#site-pin').clone();
    	editingPin.appendTo('#container-img');
    	editingPin.show();
    	editingPin.css('left', posX);
    	editingPin.css('top', posY);
    }

    function removeSite(siteKey) {
    	if (confirm("Are you sure to delete this site?")) {
    		var updates = {};
			updates['/sites/' + siteKey] = null;
			console.log(firebase.database().ref().update(updates));
    	}
    }
</script>